<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <title>TRT-Series 601</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            /* Applying dark theme base */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.6;
        }

        h1, h2 {
            color: #6fa8dc; /* Modern light blue for main headings */
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 0.5em;
        }

        h2 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 10px;
        }

        h3 {
            font-size: 1.0em; /* Slightly increased contrast for h3 */
            color: #cccccc; /* Light gray for sub-headings */
            margin-top: 15px;
            margin-bottom: 5px;
            border-bottom: 1px solid #444; /* Subtle dark border */
            padding-bottom: 3px;
        }

        .container {
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 700px;
            margin: 20px auto;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: #333333;
        }

        /* Improved Button Styles for 3D effect */
        button, .button-link {
            background-color: #007bff;
            color: white;
            padding: 10px 18px; /* Slightly more horizontal padding */
            border: none;
            border-bottom: 3px solid rgba(0, 0, 0, 0.25); /* Darker bottom border for depth */
            border-radius: 6px; /* Slightly more rounded corners */
            cursor: pointer;
            text-decoration: none;
            display: inline-flex; /* For easy icon and text alignment */
            align-items: center; /* Vertically center content (icon and text) */
            justify-content: center; /* Horizontally center content */
            margin: 5px 3px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2); /* Subtle text shadow */
            transition: background-color 0.2s ease-in-out, transform 0.15s ease, box-shadow 0.2s ease, border-bottom-width 0.15s ease;
            box-shadow: 0 2px 2px rgba(0,0,0,0.1), 0 4px 5px rgba(0,0,0,0.08); /* More elaborate shadow */
        }

        button:hover, .button-link:hover {
            background-color: #005cb3; /* Darker blue on hover */
            transform: translateY(-2px); /* Lift up slightly more */
            box-shadow: 0 4px 5px rgba(0,0,0,0.15), 0 8px 10px rgba(0,0,0,0.1); /* More pronounced shadow */
        }

        button:active, .button-link:active {
            transform: translateY(1px); /* Sink button */
            box-shadow: inset 0 2px 3px rgba(0,0,0,0.25); /* Inner shadow */
            border-bottom-width: 1px; /* Reduce bottom border on press */
            background-color: #004a8c; /* Slightly darker on press */
        }

        .status {
            font-weight: bold;
        }

        .status-on {
            color: #4CAF50;
        } /* Bright green */
        .status-off {
            color: #F44336;
        } /* Bright red */
        .status-full {
            color: #2196F3;
        } /* Bright blue */
        .status-empty {
            color: #9E9E9E;
        } /* Gray */

        input[type='range'] {
            width: calc(100% - 20px);
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #bdbdbd;
        } /* Lighter label color */

        input[type='number'], input[type='text'], input[type='password'], select {
            /* Also apply to select */
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            width: calc(100% - 20px);
            background-color: #3f3f3f; /* Dark background for inputs */
            color: #e0e0e0; /* Light text for inputs */
        }

        form button {
            margin-top: 10px;
        } /* This style is generic, the ones above will override it */

        /* Adjustments for buttons with specific colors to maintain 3D effect */
        .button-green { background-color: #28a745 !important; border-bottom-color: #1c6c2e !important; }
        .button-green:hover { background-color: #218838 !important; }
        .button-green:active { background-color: #1e7e34 !important; }

        .button-red { background-color: #dc3545 !important; border-bottom-color: #a71d2a !important; }
        .button-red:hover { background-color: #c82333 !important; }
        .button-red:active { background-color: #b21f2d !important; }

        .button-yellow { background-color: #ffc107 !important; color: black !important; border-bottom-color: #c79500 !important; text-shadow: 0 1px 1px rgba(255,255,255,0.2); }
        .button-yellow:hover { background-color: #e0a800 !important; }
        .button-yellow:active { background-color: #d39e00 !important; }

        .button-grey { background-color: #6c757d !important; border-bottom-color: #494f54 !important; }
        .button-grey:hover { background-color: #5a6268 !important; }
        .button-grey:active { background-color: #545b62 !important; }

        .button-teal { background-color: #17a2b8 !important; border-bottom-color: #0f6674 !important; }
        .button-teal:hover { background-color: #138496 !important; }
        .button-teal:active { background-color: #117a8b !important; }

        .button-orange { background-color: #fd7e14 !important; color: white !important; border-bottom-color: #c4610b !important; }
        .button-orange:hover { background-color: #e67e22 !important; }
        .button-orange:active { background-color: #d96e1c !important; }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .button-group .button-link {
            flex-grow: 1; /* Allows buttons to expand */
        }

        /* For groups of 3 buttons, we might want the third to take full width if alone on a line */
        .button-group .button-link:nth-child(3):last-child {
            flex-basis: 100%; /* If it's the 3rd and last, take full width */
        }

        /* Styles for Login Page */
        .login-page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .login-box {
            max-width: 400px;
            padding: 25px;
            background-color: #2b2b2b; /* Dark background for login box */
            border: 1px solid #444; /* Dark border */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* Improved shadow */
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: #6fa8dc;
        } /* Consistent title color */

        .login-box input[type='text'],
        .login-box input[type='password'] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #555; /* Dark border for login inputs */
            border-radius: 4px;
            background-color: #3f3f3f; /* Dark background for login inputs */
            color: #e0e0e0; /* Light text for inputs */
        }

        .login-box button {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            margin-top: 10px;
        }

        .step-block {
            border: 1px solid #007bff; /* Keep blue border to highlight steps */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #383838; /* Dark background for step blocks */
        }

        .step-block h4 {
            margin-top: 0;
            color: #6fa8dc;
        } /* Step heading color, same as h1/h2 */

        .param-group {
            margin-top: 10px;
            padding: 8px;
            border: 1px dashed #555; /* Dashed dark border */
            border-radius: 3px;
        }

        .param-group label {
            font-weight: normal;
            font-size: 0.85em;
            color: #bdbdbd;
        } /* Lighter labels within param-group */

        /* Styles for routine list items */
        .routine-list-item {
            margin-bottom: 10px;
            padding: 12px; /* Increased padding */
            border: 1px solid #4f4f4f; /* Slightly lighter border than control-group */
            border-radius: 6px; /* Consistent rounding */
            background-color: #3a3a3a; /* Darker background for item */
            color: #c0c0c0; /* General text color within item */
        }

        .routine-list-item strong {
            /* For the routine name itself */
            color: #e8e8e8; /* Brighter white for routine name */
            font-size: 1.05em;
        }

        .routine-list-item .button-link {
            margin-left: 10px;
        } /* Spacing for buttons */

        /* Status text in routine status group */
        .routine-status-group p {
            color: #d0d0d0;
            margin-bottom: 8px;
        }

        .routine-status-group p strong {
            color: #e0e0e0;
        }

        .routine-status-group p span {
            color: #79c0ff; /* Light blue for dynamic values */
            font-weight: normal;
        }

        #activeRoutineName {
            color: #ffffff;
            font-weight: bold;
        } /* Make active routine name stand out */

        /* Updated styles for Extractor Display */
        .extractor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Made cards even smaller */
            gap: 6px; /* Reduced gap further for more compactness */
            margin-top: 15px;
        }

        .extractor-card {
            padding: 5px; /* Reduced padding inside cards */
            border: 1px solid #4CAF50;
            border-radius: 6px;
            background-color: #2e7d32;
            color: #e8f5e9;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); /* Smaller shadow */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            cursor: pointer;
            height: 80px; /* Fixed height for more consistent alignment */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribute content vertically */
        }

        .extractor-card:hover {
            transform: translateY(-1px); /* Less lift on hover */
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .extractor-card strong {
            display: block;
            font-size: 0.8em; /* Smaller font for name */
            margin-bottom: 2px; /* Reduced space below name */
            color: #c8e6c9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2; /* Adjust line height for compactness */
        }

        .extractor-card .value-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1px; /* Further reduced margin */
        }

        .extractor-card .value-label {
            font-size: 0.65em; /* Even smaller label font */
            color: #a5d6a7;
            margin-bottom: 0;
            line-height: 1; /* Compact line height */
        }

        .extractor-card .value-display {
            font-size: 0.9em; /* Smaller value font */
            font-weight: bold;
            color: #ffffff;
            line-height: 1.1; /* Compact line height */
        }

        .extractor-card.warning {
            border-color: #ffb300;
            background-color: #e65100;
            color: #fff3e0;
        }

        .extractor-card.critical {
            border-color: #d32f2f;
            background-color: #b71c1c;
            color: #ffebee;
        }

        /* Styles for Extractor Configuration Page */
        #extractor-config-page .control-group {
            background-color: #3a3a3a;
            border-color: #007bff;
        }

        #extractor-config-page label {
            margin-bottom: 10px;
            font-size: 1em;
            color: #e0e0e0;
        }

        #extractor-config-page input[type="text"],
        #extractor-config-page input[type="number"] {
            margin-bottom: 15px;
        }

        /* LCD Display styles */
        .lcd-display-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: #333333;
            text-align: center;
        }

        .lcd-display {
            background-color: #000;
            border: 2px solid #555;
            border-radius: 4px;
            padding: 15px 25px; /* Increased padding */
            margin: 15px auto;
            width: fit-content;
            font-family: 'Digital-7', monospace;
            font-size: 3.5em; /* Significantly larger font size */
            color: #0f0;
            text-shadow: 0 0 8px #0f0, 0 0 15px #0f0; /* More intense glow effect */
            letter-spacing: 3px; /* Increased letter spacing */
            min-width: 220px; /* Wider to accommodate more digits */
            text-align: right;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2b2b2b;
            margin: auto;
            padding: 25px;
            border: 1px solid #444;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-content .param-group {
            margin-bottom: 15px;
            border: none;
            padding: 0;
        }

        .modal-content label {
            margin-bottom: 8px;
        }

        .modal-content input[type="number"], .modal-content select {
            width: calc(100% - 16px);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Custom Message Box */
        .custom-message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: #eee;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            font-size: 1.1em;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .custom-message-box.show {
            opacity: 1;
            display: block;
        }

        /* Simulation Page Specific Styles */
        #simulation-page {
            text-align: center;
            margin-top: 20px;
            /* Ensure it is initially hidden but can be made block by JS */
            display: none;
        }

        #simulation-canvas {
            border: 1px solid #666;
            background-color: #222;
            width: 100%;
            max-width: 600px; /* Limit width to keep it manageable */
            height: 400px; /* Fixed height for now, can be dynamic */
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        .svg-component {
            fill: #6c757d; /* Default component color (grey) */
            stroke: #444;
            stroke-width: 2;
            transition: fill 0.3s ease; /* Smooth transition for fill color */
        }

        .svg-component.active {
            fill: #4CAF50; /* Green when active */
        }
        .svg-component.warning-level {
            fill: #ffc107; /* Orange/Yellow for warning fill levels */
        }
        .svg-component.critical-level {
            fill: #dc3545; /* Red for critical fill levels */
        }
        /* New style for filling balance - REMOVED, now handled by JS direct fill */
        /* #component-5.filling-balance {
            fill: #ffbf00;
        } */

        .svg-label {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            fill: #e0e0e0;
            user-select: none;
        }

        .component-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }
        .component-button-group button {
            padding: 6px 10px;
            font-size: 0.8em;
            margin: 2px;
        }

        .component-status-display {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }
        .component-status-display .status-on { color: #4CAF50; }
        .component-status-display .status-off { color: #F44336; }

        /* Styles for Flow Arrows */
        /* Adjusted flow-up animation for longer height */
        @keyframes flow-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-210px); opacity: 0; } /* Adjusted for 200px height + fade out */
        }

        .flow-arrow {
            fill: #ffffff; /* White arrows */
            opacity: 0; /* Initially hidden by animation */
            animation: flow-up 3s linear infinite; /* Increased duration for smoother flow */
            transform-origin: center bottom; /* Important for translateY to work as expected from bottom */
        }

        /* Hide arrow groups by default, show when parent component is active */
        .flow-arrows-group {
            overflow: hidden; /* Hide arrows outside the elevator boundaries */
            position: relative; /* Needed for transform on children if using it */
        }

        /* Target the specific flow arrows within their respective parent components */
        /* Note: using ~ for sibling selector if the SVG structure places arrows right after component */
        #component-8.active ~ #flow-arrows-8 .flow-arrow,
        #component-7.active ~ #flow-arrows-7 .flow-arrow,
        #component-12.active ~ #flow-arrows-12 .flow-arrow {
            display: block; /* Show arrows when the related component is active */
        }

        /* Keyframes for rotation */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Apply rotation to elements within the active group */
        #group-component-11.active .rotating-element-11 {
            animation: rotate 1s linear infinite; /* Apply rotation when component 11's group is active */
        }

    </style>
</head>
<body>
    <div class='container'>
        <div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom: 1px solid #444;'>
            <h1>TRT-Series 601</h1>
            <div id='auth_status_container'>
                <a href='/login' class='button-link'>
                    <svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                       <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" /><path d="M20 12h-13l3 -3m0 6l-3 -3" />
                    </svg>
                    Iniciar Sesión
                </a>
            </div>
        </div>

        <!-- Main Control Page -->
        <div id="main-control-page">
            <!-- Motor Status Section -->
            <div class='control-group'>
                <h2>Estado de Motores</h2>
                <div class='extractor-grid' id='extractor-info-display'>
                    <!-- Extractor data will be injected here with JavaScript -->
                </div>
            </div>

            <!-- LCD Display and Tare control -->
            <div class="lcd-display-group control-group">
                <h2>Peso Actual</h2>
                <div class="lcd-display" id="weightDisplay">0.0 kg</div>
                <div class="button-group" style="justify-content: center;">
                    <button class="button-link button-orange" id="tareButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M6 12l12 0" />
                            <path d="M6 9l12 0" />
                            <path d="M6 15l12 0" />
                            <path d="M4 12c.76 -.116 1.48 -.403 2.11 -1.41l.89 -1.41" />
                            <path d="M4 12c.76 .116 1.48 .403 2.11 1.41l.89 1.41" />
                        </svg>
                        Tara
                    </button>
                    <button class="button-link button-green" onclick="showStartRoutineModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M7 4v16l13 -8z" />
                        </svg>
                        Iniciar Rutina
                    </button>
                </div>
            </div>


            <div class="button-group" style="justify-content: center;">
                <button class="button-link button-teal" id="showFormulasButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" />
                        <path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" />
                        <path d="M10 12h4" />
                        <path d="M10 16h4" />
                    </svg>
                    Fórmulas
                </button>
                <button class="button-link button-blue" id="showSimulationButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M18 16v-1a2 2 0 0 0 -2 -2h-5a2 2 0 0 0 -2 2v1" />
                        <path d="M6 8a6 6 0 1 0 12 0a6 6 0 1 0 -12 0" />
                    </svg>
                    Simular Rutina
                </button>
            </div>
        </div>

        <!-- Extractor Configuration Page (initially hidden) -->
        <div id="extractor-config-page" style="display:none;">
            <div class='control-group'>
                <h2>Configuración de Extractor: <span id="config-extractor-name"></span></h2>
                <div class="param-group">
                    <label for="config-ingredient-input">Contenido:</label>
                    <input type="text" id="config-ingredient-input" placeholder="Nombre del ingrediente (ej: Maíz)" />
                </div>
                <div class="param-group">
                    <label for="config-inertia-input">Inercia (kg):</label>
                    <input type="number" id="config-inertia-input" placeholder="0" min="0" value="0" />
                </div>
                <div class="button-group" style="justify-content: center; margin-top: 20px;">
                    <button class="button-link button-green" id="save-config-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 12l5 5l10 -10" />
                        </svg>
                        Guardar Configuración
                    </button>
                    <button class="button-link button-grey" id="backToMainFromConfigButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 12l14 0" />
                            <path d="M5 12l6 6" />
                            <path d="M5 12l6 -6" />
                        </svg>
                        Volver
                    </button>
                </div>
            </div>
        </div>


        <!-- Formulas Page (initially hidden) -->
        <div id="formulas-page" style="display:none;">
            <div class='control-group'>
                <h2>Gestión de Fórmulas</h2>
                <div class="param-group">
                    <label for="formulaNameInput">Nombre de fórmula:</label>
                    <input type="text" id="formulaNameInput" placeholder="Ej: Molienda Fina" />
                </div>

                <div id="formulas-form-container">
                    <!-- The ingredient and kilogram fields will be injected here -->
                </div>

                <div class="button-group" style="justify-content: center; margin-top: 20px;">
                    <button class="button-link button-green" id="saveFormulaButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                            <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                            <path d="M14 4l0 4l-6 0l0 -4" />
                        </svg>
                        Guardar Fórmula
                    </button>
                    <button class="button-link button-grey" id="backToMainFromFormulasButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 12l14 0" />
                            <path d="M5 12l6 6" />
                            <path d="M5 12l6 -6" />
                        </svg>
                        Volver
                    </button>
                </div>
            </div>

            <div class='control-group'>
                <h2>Listado de Fórmulas Guardadas</h2>
                <div id="saved-formulas-list">
                    <!-- Saved formulas will be injected here -->
                    <p style="text-align: center; color: #aaa;">No hay fórmulas guardadas.</p>
                </div>
            </div>
        </div>

        <!-- Simulation Page (initially hidden) -->
        <div id="simulation-page" style="display:none;">
            <div class='control-group'>
                <h2>Simulación de Planta de Molienda</h2>
                <div id="simulation-canvas-container">
                    <svg id="simulation-canvas" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
                        <!-- Background/Floor -->
                        <rect x="0" y="0" width="600" height="400" fill="#222"/>

                        <!-- Shared arrow definition -->
                        <defs>
                            <!-- Smaller arrow: 6px width, 6px height (tip to base) -->
                            <polygon id="up-arrow" points="0,6 3,0 6,6" fill="#ffffff"/>
                        </defs>

                        <!-- Main Input/Storage (Top rectangular block) -->
                        <rect x="150" y="20" width="300" height="50" rx="5" ry="5" class="svg-component" id="component-main-silo"/>
                        <text x="300" y="48" text-anchor="middle" class="svg-label">Almacén Principal</text>

                        <!-- Pipes from Main Storage -->
                        <rect x="150" y="70" width="20" height="60" fill="#add8e6" stroke="#4a4a4a" stroke-width="2"/> <!-- Pipe down left -->
                        <rect x="430" y="70" width="20" height="60" fill="#add8e6" stroke="#4a4a4a" stroke-width="2"/> <!-- Pipe down right -->
                        <line x1="160" y1="130" x2="160" y2="150" stroke="#add8e6" stroke-width="12"/> <!-- Left vertical section -->
                        <line x1="440" y1="130" x2="440" y2="150" stroke="#add8e6" stroke-width="12"/> <!-- Right vertical section -->

                        <!-- Left Branch Components -->
                        <!-- Pulmón Mezcladora (1) - top-left hexagonal silo -->
                        <polygon points="130,150 190,150 200,200 120,200 130,150" class="svg-component" id="component-1-pulmon"/>
                        <text x="160" y="175" text-anchor="middle" class="svg-label">Pulmón Mez. (1)</text>

                        <!-- Paso Mezcladora (11) - circular valve/motor -->
                        <g id="group-component-11">
                            <circle cx="160" cy="220" r="12" class="svg-component" id="component-11"/>
                            <text x="160" y="245" text-anchor="middle" class="svg-label">Paso Mez. (11)</text>
                            <!-- Rotating element for component 11 -->
                            <circle cx="160" cy="220" r="5" fill="#a0a0a0" class="rotating-element-11"/>
                            <line x1="155" y1="220" x2="165" y2="220" stroke="#e0e0e0" stroke-width="1.5" class="rotating-element-11"/>
                            <line x1="160" y1="215" x2="160" y2="225" stroke="#e0e0e0" stroke-width="1.5" class="rotating-element-11"/>
                        </g>
                        <!-- Pipe connecting Pulmón Mez. (1) to Paso Mez. (11) -->
                        <line x1="160" y1="200" x2="160" y2="208" stroke="#add8e6" stroke-width="12"/>

                        <!-- Mezcladora (mixer-tank) - hexagonal below valve -->
                        <polygon points="130,260 190,260 200,310 120,310 130,260" class="svg-component" id="mixer-tank"/>
                        <text x="160" y="285" text-anchor="middle" class="svg-label">Mezcladora</text>
                        <!-- Pipe connecting Paso Mez. (11) to Mezcladora -->
                        <line x1="160" y1="232" x2="160" y2="260" stroke="#add8e6" stroke-width="12"/>

                        <!-- Abre Mezcladora (3) - valve below mixer -->
                        <circle cx="160" cy="330" r="10" class="svg-component" id="component-3"/>
                        <text x="160" y="350" text-anchor="middle" class="svg-label">Abre Mez. (3)</text>
                        <!-- Pipe connecting Mezcladora to Abre Mez. (3) -->
                        <line x1="160" y1="310" x2="160" y2="320" stroke="#add8e6" stroke-width="12"/>

                        <!-- Noria Mezcladora (12) - vertical elevator (far left) -->
                        <rect x="50" y="150" width="30" height="200" rx="3" ry="3" class="svg-component" id="component-12"/>
                        <text x="65" y="250" text-anchor="middle" transform="rotate(90 65 250)" class="svg-label">Noria Mez. (12)</text>
                        <g class="flow-arrows-group" id="flow-arrows-12">
                            <!-- Flechas para Noria Mezcladora (x_center = 65, width = 30, height = 200) -->
                            <!-- Column 1 -->
                            <use href="#up-arrow" x="52" y="340" class="flow-arrow" style="animation-delay: 0s;"/>
                            <use href="#up-arrow" x="52" y="315" class="flow-arrow" style="animation-delay: 0.2s;"/>
                            <use href="#up-arrow" x="52" y="290" class="flow-arrow" style="animation-delay: 0.4s;"/>
                            <use href="#up-arrow" x="52" y="265" class="flow-arrow" style="animation-delay: 0.6s;"/>
                            <use href="#up-arrow" x="52" y="240" class="flow-arrow" style="animation-delay: 0.8s;"/>
                            <use href="#up-arrow" x="52" y="215" class="flow-arrow" style="animation-delay: 1s;"/>
                            <use href="#up-arrow" x="52" y="190" class="flow-arrow" style="animation-delay: 1.2s;"/>
                            <use href="#up-arrow" x="52" y="165" class="flow-arrow" style="animation-delay: 1.4s;"/>
                            <!-- Column 2 -->
                            <use href="#up-arrow" x="60" y="340" class="flow-arrow" style="animation-delay: 0.05s;"/>
                            <use href="#up-arrow" x="60" y="315" class="flow-arrow" style="animation-delay: 0.25s;"/>
                            <use href="#up-arrow" x="60" y="290" class="flow-arrow" style="animation-delay: 0.45s;"/>
                            <use href="#up-arrow" x="60" y="265" class="flow-arrow" style="animation-delay: 0.65s;"/>
                            <use href="#up-arrow" x="60" y="240" class="flow-arrow" style="animation-delay: 0.85s;"/>
                            <use href="#up-arrow" x="60" y="215" class="flow-arrow" style="animation-delay: 1.05s;"/>
                            <use href="#up-arrow" x="60" y="190" class="flow-arrow" style="animation-delay: 1.25s;"/>
                            <use href="#up-arrow" x="60" y="165" class="flow-arrow" style="animation-delay: 1.45s;"/>
                            <!-- Column 3 -->
                            <use href="#up-arrow" x="68" y="340" class="flow-arrow" style="animation-delay: 0.1s;"/>
                            <use href="#up-arrow" x="68" y="315" class="flow-arrow" style="animation-delay: 0.3s;"/>
                            <use href="#up-arrow" x="68" y="290" class="flow-arrow" style="animation-delay: 0.5s;"/>
                            <use href="#up-arrow" x="68" y="265" class="flow-arrow" style="animation-delay: 0.7s;"/>
                            <use href="#up-arrow" x="68" y="240" class="flow-arrow" style="animation-delay: 0.9s;"/>
                            <use href="#up-arrow" x="68" y="215" class="flow-arrow" style="animation-delay: 1.1s;"/>
                            <use href="#up-arrow" x="68" y="190" class="flow-arrow" style="animation-delay: 1.3s;"/>
                            <use href="#up-arrow" x="68" y="165" class="flow-arrow" style="animation-delay: 1.5s;"/>
                        </g>

                        <!-- Pipe from Abre Mezcladora (3) to Noria Mezcladora (12) -->
                        <line x1="160" y1="340" x2="160" y2="350" stroke="#add8e6" stroke-width="12"/>
                        <line x1="160" y1="350" x2="65" y2="350" stroke="#add8e6" stroke-width="12"/>
                        <line x1="65" y1="350" x2="65" y2="340" stroke="#add8e6" stroke-width="12"/>


                        <!-- Right Branch Components -->
                        <!-- Pulmón del Molino (2) - top-right hexagonal silo -->
                        <polygon points="410,150 470,150 480,200 400,200 410,150" class="svg-component" id="component-2"/>
                        <text x="440" y="175" text-anchor="middle" class="svg-label">Pulmón Mol. (2)</text>
                        <!-- Pipe connecting main storage to Pulmón Molino (2) -->
                        <line x1="440" y1="130" x2="440" y2="150" stroke="#add8e6" stroke-width="12"/>

                        <!-- New Valve (component-valve-right-branch) below Pulmón Molino (2) -->
                        <circle cx="440" cy="220" r="10" class="svg-component" id="component-valve-right-branch"/>
                        <text x="440" y="240" text-anchor="middle" class="svg-label">Válvula</text>
                        <!-- Pipe connecting Pulmón Molino (2) to new valve -->
                        <line x1="440" y1="200" x2="440" y2="210" stroke="#add8e6" stroke-width="12"/>


                        <!-- Molino (4) - hexagonal below new valve -->
                        <polygon points="410,260 470,260 480,310 400,310 410,260" class="svg-component" id="component-4"/>
                        <text x="440" y="285" text-anchor="middle" class="svg-label">Molino (4)</text>
                        <!-- Pipe connecting new valve to Molino (4) -->
                        <line x1="440" y1="230" x2="440" y2="260" stroke="#add8e6" stroke-width="12"/>

                        <!-- Elevador del Molino (7) - vertical elevator (far right) -->
                        <rect x="510" y="150" width="30" height="200" rx="3" ry="3" class="svg-component" id="component-7"/>
                        <text x="525" y="250" text-anchor="middle" transform="rotate(90 525 250)" class="svg-label">Elev. Mol. (7)</text>
                        <g class="flow-arrows-group" id="flow-arrows-7">
                            <!-- Flechas para Elevador Molino (x_center = 525, width = 30, height = 200) -->
                            <!-- Column 1 -->
                            <use href="#up-arrow" x="512" y="340" class="flow-arrow" style="animation-delay: 0s;"/>
                            <use href="#up-arrow" x="512" y="315" class="flow-arrow" style="animation-delay: 0.2s;"/>
                            <use href="#up-arrow" x="512" y="290" class="flow-arrow" style="animation-delay: 0.4s;"/>
                            <use href="#up-arrow" x="512" y="265" class="flow-arrow" style="animation-delay: 0.6s;"/>
                            <use href="#up-arrow" x="512" y="240" class="flow-arrow" style="animation-delay: 0.8s;"/>
                            <use href="#up-arrow" x="512" y="215" class="flow-arrow" style="animation-delay: 1s;"/>
                            <use href="#up-arrow" x="512" y="190" class="flow-arrow" style="animation-delay: 1.2s;"/>
                            <use href="#up-arrow" x="512" y="165" class="flow-arrow" style="animation-delay: 1.4s;"/>
                            <!-- Column 2 -->
                            <use href="#up-arrow" x="520" y="340" class="flow-arrow" style="animation-delay: 0.05s;"/>
                            <use href="#up-arrow" x="520" y="315" class="flow-arrow" style="animation-delay: 0.25s;"/>
                            <use href="#up-arrow" x="520" y="290" class="flow-arrow" style="animation-delay: 0.45s;"/>
                            <use href="#up-arrow" x="520" y="265" class="flow-arrow" style="animation-delay: 0.65s;"/>
                            <use href="#up-arrow" x="520" y="240" class="flow-arrow" style="animation-delay: 0.85s;"/>
                            <use href="#up-arrow" x="520" y="215" class="flow-arrow" style="animation-delay: 1.05s;"/>
                            <use href="#up-arrow" x="520" y="190" class="flow-arrow" style="animation-delay: 1.25s;"/>
                            <use href="#up-arrow" x="520" y="165" class="flow-arrow" style="animation-delay: 1.45s;"/>
                            <!-- Column 3 -->
                            <use href="#up-arrow" x="528" y="340" class="flow-arrow" style="animation-delay: 0.1s;"/>
                            <use href="#up-arrow" x="528" y="315" class="flow-arrow" style="animation-delay: 0.3s;"/>
                            <use href="#up-arrow" x="528" y="290" class="flow-arrow" style="animation-delay: 0.5s;"/>
                            <use href="#up-arrow" x="528" y="265" class="flow-arrow" style="animation-delay: 0.7s;"/>
                            <use href="#up-arrow" x="528" y="240" class="flow-arrow" style="animation-delay: 0.9s;"/>
                            <use href="#up-arrow" x="528" y="215" class="flow-arrow" style="animation-delay: 1.1s;"/>
                            <use href="#up-arrow" x="528" y="190" class="flow-arrow" style="animation-delay: 1.3s;"/>
                            <use href="#up-arrow" x="528" y="165" class="flow-arrow" style="animation-delay: 1.5s;"/>
                        </g>
                        <!-- Pipe connecting Molino (4) to Elevador Molino (7) -->
                        <line x1="440" y1="310" x2="440" y2="350" stroke="#add8e6" stroke-width="12"/>
                        <line x1="440" y1="350" x2="525" y2="350" stroke="#add8e6" stroke-width="12"/>
                        <line x1="525" y1="350" x2="525" y2="340" stroke="#add8e6" stroke-width="12"/>


                        <!-- Central Pipe Routing (Top horizontal and down to balance) -->
                        <line x1="160" y1="90" x2="440" y2="90" stroke="#add8e6" stroke-width="12"/> <!-- Horizontal pipe top -->
                        <line x1="300" y1="90" x2="300" y2="280" stroke="#add8e6" stroke-width="12"/> <!-- Pipe down to balance -->

                        <!-- Balance (component-5) - trapezoidal in center bottom -->
                        <polygon points="250,280 350,280 340,340 260,340" class="svg-component" id="component-5"/>
                        <text x="300" y="305" text-anchor="middle" class="svg-label">Balanza (5)</text>
                        <text x="300" y="325" text-anchor="middle" class="svg-label" id="balance-weight-display">0.00 kg</text>

                        <!-- Pipe from Balance to Bottom Output -->
                        <line x1="300" y1="340" x2="300" y2="360" stroke="#add8e6" stroke-width="12"/>
                        <rect x="270" y="360" width="60" height="20" rx="3" ry="3" class="svg-component" id="component-output-bottom"/>
                        <text x="300" y="375" text-anchor="middle" class="svg-label">Salida</text>

                    </svg>
                </div>
                <div class="button-group" style="justify-content: center; margin-top: 20px;">
                    <button class="button-link button-grey" id="backToMainFromSimulationButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 12l14 0" />
                            <path d="M5 12l6 6" />
                            <path d="M5 12l6 -6" />
                        </svg>
                        Volver
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for Starting Routine -->
    <div id="startRoutineModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>Iniciar Rutina de Molienda</h2>
            <div class="param-group">
                <label for="selectFormula">Seleccionar Fórmula:</label>
                <select id="selectFormula" style="width: 100%;">
                    <!-- Formula options will be loaded here -->
                </select>
            </div>
            <div class="param-group">
                <label for="targetKilograms">Cantidad de Kilogramos a Producir:</label>
                <input type="number" id="targetKilograms" placeholder="0" min="0" value="0" />
            </div>
            <div class="modal-footer">
                <button class="button-link button-green" id="startRoutineButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M7 4v16l13 -8z" />
                    </svg>
                    Comenzar
                </button>
                <button class="button-link button-red" id="cancelRoutineButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M18 6l-12 12" />
                        <path d="M6 6l12 12" />
                    </svg>
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="customMessageBox" class="custom-message-box"></div>

    <script>
        // Global array to store extractor data (name and inertia)
        let extractorIngredients = Array.from({length: 11}, (_, i) => ({
            name: `Extractor S${i + 1}`,
            inertia: 0 // Default inertia
        }));

        // Variable to keep track of which extractor is being edited
        let currentEditingExtractorId = -1;
        // Global variable for weight simulation
        let currentWeight = 0.0;
        let weightInterval = null; // To store the interval ID for clearing
        // Global array to store saved formulas
        let savedFormulas = [];
        // Define static temperatures for the extractors (expanded to 11)
        const staticTemperatures = [44, 38, 55, 41, 68, 35, 48, 60, 52, 39, 65];
        // Define base RPMs for each extractor (expanded to 11)
        const baseRpmValues = [950, 1020, 880, 1100, 990, 850, 930, 1050, 970, 890, 1000];
        const NUM_EXTRACTORS = extractorIngredients.length; // Number of extractors

        // State for simulation components - UPDATED FOR NEW LAYOUT
        const simulationComponents = {
            'component-main-silo': { active: false, label: 'Almacén Principal', fill: 0 },
            'component-1-pulmon': { active: false, label: 'Pulmón Mez. (1)', fill: 0 },
            'component-11': { active: false, label: 'Paso Mezcladora (11)' }, // Refers to the group's state
            'mixer-tank': { active: false, label: 'Mezcladora', fill: 0 },
            'component-3': { active: false, label: 'Abre Mez. (3)' },
            'component-12': { active: false, label: 'Noria Mez. (12)' },
            'component-2': { active: false, label: 'Pulmón Mol. (2)', fill: 0 },
            'component-valve-right-branch': { active: false, label: 'Válvula (Derecha)' }, // New component
            'component-4': { active: false, label: 'Molino (4)'},
            'component-7': { active: false, label: 'Elevador Mol. (7)' },
            'component-5': { active: false, label: 'Balanza (5)' },
            'component-output-bottom': { active: false, label: 'Salida' } // New component
        };

        // Helper function to get a random integer within a range
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Helper function for custom message box
        function showMessageBox(message, duration = 3000) {
            const msgBox = document.getElementById('customMessageBox');
            msgBox.innerText = message;
            msgBox.classList.add('show');
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        // --- Page Navigation Functions ---
        function showPage(pageId) {
            document.getElementById('main-control-page').style.display = 'none';
            document.getElementById('formulas-page').style.display = 'none';
            document.getElementById('extractor-config-page').style.display = 'none';
            document.getElementById('simulation-page').style.display = 'none';

            document.getElementById(pageId).style.display = 'block';
        }

        // --- Extractor Logic ---

        // Function to navigate to and open the extractor configuration page
        function showExtractorConfigPage(extractorId) {
            currentEditingExtractorId = extractorId;
            const configIngredientInput = document.getElementById('config-ingredient-input');
            const configInertiaInput = document.getElementById('config-inertia-input');
            const currentExtractorNameForConfig = document.getElementById('config-extractor-name');

            const extractorData = extractorIngredients[extractorId];

            currentExtractorNameForConfig.innerText = `Extractor S${extractorId + 1}`;
            configIngredientInput.value = extractorData.name;
            configInertiaInput.value = extractorData.inertia;

            showPage('extractor-config-page');
        }

        // Function to save extractor configuration
        function saveExtractorConfig() {
            const newName = document.getElementById('config-ingredient-input').value;
            const newInertia = parseFloat(document.getElementById('config-inertia-input').value);

            if (currentEditingExtractorId !== -1) {
                extractorIngredients[currentEditingExtractorId].name = newName.trim() || `Extractor S${currentEditingExtractorId + 1}`;
                extractorIngredients[currentEditingExtractorId].inertia = isNaN(newInertia) ? 0 : newInertia;

                localStorage.setItem('extractorIngredients', JSON.stringify(extractorIngredients));
                updateExtractorStatus(); // Re-render main page extractors
                showMessageBox("Configuración de extractor guardada.");
                
                showPage('main-control-page'); // Go back to main page after saving
                currentEditingExtractorId = -1; // Reset edited extractor ID
            }
        }


        // Main function to update extractor status display
        function updateExtractorStatus() {
            const extractorContainer = document.getElementById('extractor-info-display');
            extractorContainer.innerHTML = ''; // Clear existing content

            for (let i = 0; i < NUM_EXTRACTORS; i++) {
                const temp = staticTemperatures[i];
                const baseRpm = baseRpmValues[i];

                // Simulate RPM with a very small variation (-1, 0, 1, or 2 RPM)
                const rpmVariation = getRandomInt(-1, 2);
                const currentRpm = baseRpm + rpmVariation;

                const extractorData = extractorIngredients[i];
                const extractorName = extractorData.name;
                // Note: inertia is NOT displayed here

                let cardClass = 'extractor-card';
                // Add warning or critical classes based on temperature
                if (temp > 60) {
                    cardClass += ' critical'; // High temperature
                } else if (temp > 50) {
                    cardClass += ' warning'; // Elevated temperature
                }

                // Construct the HTML for each extractor card
                // The onclick handler now calls showExtractorConfigPage
                const extractorHtml = `
                    <div class='${cardClass}' data-index='${i}' onclick='showExtractorConfigPage(${i})'>
                        <strong>${extractorName}</strong>
                        <div class='value-row'>
                            <span class='value-label'>Temp:</span>
                            <span class='value-display'>${temp} C°</span>
                        </div>
                        <div class='value-row'>
                            <span class='value-label'>RPM:</span>
                            <span class='value-display'>${currentRpm}</span>
                        </div>
                    </div>
                `;
                extractorContainer.innerHTML += extractorHtml;
            }
        }

        // --- Weight Display Logic ---

        // Helper function to interpolate between two hex colors
        function interpolateColor(color1, color2, factor) {
            const hexToRgb = hex => ({
                r: parseInt(hex.slice(1, 3), 16),
                g: parseInt(hex.slice(3, 5), 16),
                b: parseInt(hex.slice(5, 7), 16)
            });
            const rgbToHex = rgb => '#' + ((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1).toUpperCase();

            const c1 = hexToRgb(color1);
            const c2 = hexToRgb(color2);

            const r = Math.round(c1.r + factor * (c2.r - c1.r));
            const g = Math.round(c1.g + factor * (c2.g - c1.g));
            const b = Math.round(c1.b + factor * (c2.b - c1.b));

            return rgbToHex({ r, g, b });
        }

        // Function to start weight simulation
        function startWeightSimulation() {
            if (weightInterval) clearInterval(weightInterval); // Clear any existing interval
            // Simulate initial non-zero weight for effect if needed
            currentWeight = parseFloat((Math.random() * 5 + 0.1).toFixed(2)); // Start with a small random weight, 2 decimals
            updateWeightDisplay();
            weightInterval = setInterval(() => {
                // Simulate slight fluctuation around the current weight
                currentWeight += (Math.random() * 1 - 0.5); // Adds/subtracts between -0.5 and 0.5
                if (currentWeight < 0) currentWeight = 0; // Prevent negative weight
                updateWeightDisplay();
            }, 500); // Update every 0.5 seconds
        }

        // Function to update the LCD weight display and balance color
        function updateWeightDisplay() {
            const weightDisplayElem = document.getElementById('weightDisplay');
            const balanceSVG = document.getElementById('component-5'); // Get the balance SVG element
            
            if (weightDisplayElem) {
                // Ensure 2 decimal places are always displayed
                weightDisplayElem.innerText = `${currentWeight.toFixed(2)} kg`;
                // Update balance weight display in simulation page if visible
                const balanceWeightDisplay = document.getElementById('balance-weight-display');
                if (balanceWeightDisplay) {
                    balanceWeightDisplay.innerText = `${currentWeight.toFixed(2)} kg`;
                }
            }

            // Update balance color based on weight
            if (balanceSVG) {
                const maxBalanceCapacity = 1000;
                let fillRatio = currentWeight / maxBalanceCapacity;
                if (fillRatio < 0) fillRatio = 0;
                if (fillRatio > 1) fillRatio = 1;

                const defaultColor = '#6c757d'; // Gray
                const fillingColor = '#ffbf00'; // Yellow

                // Interpolate color only if there's a significant amount of weight, otherwise keep default
                if (currentWeight > 0.01) { // A very small threshold to start coloring
                    balanceSVG.style.fill = interpolateColor(defaultColor, fillingColor, fillRatio);
                } else {
                    balanceSVG.style.fill = defaultColor; // Revert to default when empty
                }
            }
        }

        // Function to tare the weight
        function tareWeight() {
            currentWeight = 0.0;
            updateWeightDisplay();
            showMessageBox("Tara aplicada. Peso reiniciado a 0.00 kg.");
        }

        // --- Formula Management Logic ---

        // Function to render the formula input fields dynamically
        function renderFormulasPage() {
            const formulasFormContainer = document.getElementById('formulas-form-container');
            formulasFormContainer.innerHTML = ''; // Clear existing content

            for (let i = 0; i < NUM_EXTRACTORS; i++) {
                const extractorData = extractorIngredients[i];
                const ingredientName = extractorData.name; // Use stored name

                const formulaFieldHtml = `
                    <div class="param-group">
                        <h3>${ingredientName}</h3>
                        <label for="kgInput-${i}">Cantidad (kg):</label>
                        <input type="number" id="kgInput-${i}" placeholder="0" min="0" value="0" />
                    </div>
                `;
                formulasFormContainer.innerHTML += formulaFieldHtml;
            }
        }

        // Function to save a formula
        function saveFormula() {
            const formulaNameInput = document.getElementById('formulaNameInput');
            const formulaName = formulaNameInput.value.trim();

            if (!formulaName) {
                showMessageBox("Por favor, ingresa un nombre para la fórmula.");
                return;
            }

            const formulaData = {
                name: formulaName,
                ingredients: {}
            };

            let allIngredientsEmpty = true;
            for (let i = 0; i < NUM_EXTRACTORS; i++) {
                const extractorData = extractorIngredients[i];
                const ingredientName = extractorData.name; // Use stored name
                const kgInput = document.getElementById(`kgInput-${i}`);
                const kgValue = parseFloat(kgInput.value);

                if (!isNaN(kgValue) && kgValue > 0) {
                    formulaData.ingredients[ingredientName] = kgValue;
                    allIngredientsEmpty = false;
                }
            }

            if (allIngredientsEmpty) {
                 showMessageBox("La fórmula no puede estar vacía. Por favor, ingresa al menos una cantidad de ingrediente.");
                 return;
            }

            // Check if formula with this name already exists
            const existingFormulaIndex = savedFormulas.findIndex(f => f.name === formulaName);
            if (existingFormulaIndex > -1) {
                // Update existing formula
                savedFormulas[existingFormulaIndex] = formulaData;
                showMessageBox(`Fórmula '${formulaName}' actualizada con éxito.`);
            } else {
                // Add new formula
                savedFormulas.push(formulaData);
                showMessageBox(`Fórmula '${formulaName}' guardada con éxito.`);
            }

            localStorage.setItem('savedFormulas', JSON.stringify(savedFormulas)); // Save to localStorage
            formulaNameInput.value = ''; // Clear formula name input
            renderFormulasPage(); // Reset kg inputs
            renderSavedFormulas(); // Update the list of saved formulas
        }

        // Function to load formulas from localStorage
        function loadFormulas() {
            const storedFormulas = localStorage.getItem('savedFormulas');
            if (storedFormulas) {
                savedFormulas = JSON.parse(storedFormulas);
            }
        }

        // Function to render the list of saved formulas
        function renderSavedFormulas() {
            const savedFormulasList = document.getElementById('saved-formulas-list');
            savedFormulasList.innerHTML = ''; // Clear existing content

            if (savedFormulas.length === 0) {
                savedFormulasList.innerHTML = '<p style="text-align: center; color: #aaa;">No hay fórmulas guardadas.</p>';
                return;
            }

            savedFormulas.forEach((formula, index) => {
                const formulaItem = document.createElement('div');
                formulaItem.classList.add('routine-list-item');
                formulaItem.style.display = 'flex';
                formulaItem.style.justifyContent = 'space-between';
                formulaItem.style.alignItems = 'center';

                let ingredientsSummary = Object.entries(formula.ingredients)
                    .map(([name, kg]) => `${name}: ${kg}kg`)
                    .join(', ');
                if (ingredientsSummary.length > 50) { // Truncate if too long
                    ingredientsSummary = ingredientsSummary.substring(0, 47) + '...';
                }

                formulaItem.innerHTML = `
                    <div>
                        <strong>${formula.name}</strong><br>
                        <span style="font-size: 0.85em; color: #999;">Ingredientes: ${ingredientsSummary || 'Ninguno'}</span>
                    </div>
                    <div class="button-group" style="margin: 0;">
                        <button class="button-link button-green" onclick="showStartRoutineModal('${formula.name}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M7 4v16l13 -8z" />
                            </svg>
                            Iniciar Rutina
                        </button>
                        <button class="button-link button-red" onclick="deleteFormula(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 6px;'>
                               <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                            </svg>
                            Eliminar
                        </button>
                    </div>
                `;
                savedFormulasList.appendChild(formulaItem);
            });
        }

        // Function to delete a formula with custom confirmation
        function deleteFormula(index) {
            showMessageBox(`¿Estás seguro de que quieres eliminar la fórmula '${savedFormulas[index].name}'?`, 0); // Show indefinitely until action
            const msgBox = document.getElementById('customMessageBox');
            msgBox.innerHTML += `
                <div class="button-group" style="margin-top: 15px; justify-content: center;">
                    <button class="button-link button-red" onclick="confirmDeleteFormula(${index}, true)">Sí</button>
                    <button class="button-link button-grey" onclick="confirmDeleteFormula(${index}, false)">No</button>
                </div>
            `;
        }

        function confirmDeleteFormula(index, confirmed) {
            const msgBox = document.getElementById('customMessageBox');
            msgBox.classList.remove('show');
            msgBox.innerHTML = ''; // Clear message box content

            if (confirmed) {
                savedFormulas.splice(index, 1);
                localStorage.setItem('savedFormulas', JSON.stringify(savedFormulas));
                renderSavedFormulas();
                showMessageBox("Fórmula eliminada con éxito.");
            }
        }


        // --- Start Routine Modal Logic ---

        // Function to show the start routine modal
        function showStartRoutineModal(preSelectedFormulaName = null) {
            const modal = document.getElementById('startRoutineModal');
            const selectFormula = document.getElementById('selectFormula');
            selectFormula.innerHTML = ''; // Clear previous options

            if (savedFormulas.length === 0) {
                selectFormula.innerHTML = '<option value="">No hay fórmulas disponibles</option>';
                // Optionally disable the start button if no formulas
                document.getElementById('startRoutineButton').disabled = true;
            } else {
                document.getElementById('startRoutineButton').disabled = false;
                savedFormulas.forEach(formula => {
                    const option = document.createElement('option');
                    option.value = formula.name;
                    option.innerText = formula.name;
                    selectFormula.appendChild(option);
                });

                // Pre-select a formula if one was passed
                if (preSelectedFormulaName) {
                    selectFormula.value = preSelectedFormulaName;
                }
            }

            document.getElementById('targetKilograms').value = 0; // Reset kilograms input
            modal.style.display = 'flex'; // Show the modal
        }

        // Function to hide the start routine modal
        function hideStartRoutineModal() {
            const modal = document.getElementById('startRoutineModal');
            modal.style.display = 'none';
        }

        // Function to initiate the routine
        function startRoutine() {
            const selectedFormulaName = document.getElementById('selectFormula').value;
            const targetKilograms = parseFloat(document.getElementById('targetKilograms').value);

            if (!selectedFormulaName) {
                showMessageBox("Por favor, selecciona una fórmula.");
                return;
            }
            if (isNaN(targetKilograms) || targetKilograms <= 0) {
                showMessageBox("Por favor, ingresa una cantidad de kilogramos válida (> 0).");
                return;
            }

            const selectedFormula = savedFormulas.find(f => f.name === selectedFormulaName);

            if (selectedFormula) {
                const confirmationMessage = `Iniciando rutina con la fórmula '${selectedFormula.name}' para producir ${targetKilograms} kg.
                Ingredientes necesarios: ${Object.entries(selectedFormula.ingredients).map(([name, kg]) => `${name}: ${kg}kg`).join(', ')}`;
                showMessageBox(confirmationMessage, 5000); // Show for a longer duration

                // --- Simulation of routine start (placeholder) ---
                console.log("Rutina Iniciada:");
                console.log("Fórmula:", selectedFormula);
                console.log("Kilogramos a producir:", targetKilograms);

                // Here, you would implement the actual logic to control the extractors
                // based on the formula and target kilograms, taking inertia into account.
                // For demonstration, we'll just log it.

                hideStartRoutineModal(); // Close the modal
            } else {
                showMessageBox("Error: Fórmula seleccionada no encontrada.");
            }
        }

        // --- Simulation Page Logic ---

        // Function to render the current state of simulation components
        function renderSimulationState() {
            // Update visual state of SVG components based on simulationComponents object
            for (const id in simulationComponents) {
                // Special handling for component 11 group
                let elementToApplyActive = document.getElementById(id);
                if (id === 'component-11') {
                    elementToApplyActive = document.getElementById('group-component-11');
                }

                if (elementToApplyActive) {
                    if (simulationComponents[id].active) {
                        elementToApplyActive.classList.add('active');
                    } else {
                        elementToApplyActive.classList.remove('active');
                    }
                    // Handle fill levels if applicable (e.g., for silos, pulmones, mezcladora)
                    if (simulationComponents[id].fill !== undefined) {
                        // For a simple visual, we can change fill color based on level
                        if (simulationComponents[id].fill > 80) {
                            elementToApplyActive.classList.add('critical-level');
                            elementToApplyActive.classList.remove('warning-level');
                        } else if (simulationComponents[id].fill > 40) {
                            elementToApplyActive.classList.add('warning-level');
                            elementToApplyActive.classList.remove('critical-level');
                        } else {
                            elementToApplyActive.classList.remove('warning-level', 'critical-level');
                        }
                    }
                }
            }
            // Ensure balance color is updated even if no component state changes
            updateWeightDisplay();
        }

        // Function to toggle a component's state
        function toggleComponent(componentId) {
            const component = simulationComponents[componentId];
            if (!component) return;

            // For component 11, toggle the active class on its group
            let elementToToggle = document.getElementById(componentId);
            if (componentId === 'component-11') {
                elementToToggle = document.getElementById('group-component-11');
            }

            component.active = !component.active;
            
            // Toggle the 'active' class on the relevant SVG element/group
            if (elementToToggle) {
                elementToToggle.classList.toggle('active');
            }
            
            // This part is for the flow arrows visibility
            const flowArrowsGroup = document.getElementById(`flow-arrows-${componentId}`);
            if (flowArrowsGroup) {
                if (component.active) {
                    flowArrowsGroup.style.display = 'block';
                } else {
                    flowArrowsGroup.style.display = 'none';
                }
            }

            renderSimulationState(); // Re-render to reflect changes
            showMessageBox(`${component.label}: ${component.active ? 'ENCENDIDO' : 'APAGADO'}`);

            // Special logic for Alimentador de Molino (10) RPM (if still relevant in new layout)
            if (componentId === 'component-10') { // Assuming 'component-10' is still the 'Alimentador Molino'
                if (component.active) {
                    component.rpm = 15; // Set a default RPM when active
                    showMessageBox(`Alimentador Molino (10): RPM a 15`);
                } else {
                    component.rpm = 0;
                }
            }

            // Simulate weight change for Balanza (5) if inflow/outflow components are active
            const balanceComponent = simulationComponents['component-5'];
            if (balanceComponent) {
                // If any upstream component feeding the balance is active, simulate inflow
                // In the new diagram, this seems to be the pipe coming down from the top-central pipe
                const isReceivingMaterial = simulationComponents['component-main-silo'].active;
                
                // If a component outputting from the balance is active, simulate outflow
                const isOutputtingMaterial = simulationComponents['component-output-bottom'].active;

                if (weightInterval) clearInterval(weightInterval); // Clear any existing interval

                if (isReceivingMaterial && !isOutputtingMaterial) {
                    weightInterval = setInterval(() => {
                        currentWeight += (Math.random() * 20 + 10); // Increase weight (10-30 kg/100ms)
                        if (currentWeight > 1000) currentWeight = 1000; // Max balance weight
                        updateWeightDisplay();
                    }, 100);
                } else if (!isReceivingMaterial && isOutputtingMaterial && currentWeight > 0) {
                     weightInterval = setInterval(() => {
                        currentWeight -= (Math.random() * 5 + 2); // Decrease weight (2-7 kg/200ms)
                        if (currentWeight < 0) currentWeight = 0;
                        updateWeightDisplay();
                        if (currentWeight <= 0) {
                            clearInterval(weightInterval);
                            weightInterval = null;
                            showMessageBox("Balanza vacía.");
                            // Consider if the output component should turn off automatically
                            // simulationComponents['component-output-bottom'].active = false;
                            // renderSimulationState();
                            // updateAllComponentStatusDisplays();
                        }
                    }, 200);
                } else {
                    // If no active inflow/outflow, resume normal fluctuation or stop
                    startWeightSimulation(); // Revert to slight fluctuation
                }
            }


            updateAllComponentStatusDisplays(); // Ensure button statuses are updated
        }

        // Function to update the RPM of Alimentador Molino (10)
        // This function might become obsolete if component-10 is not controlled directly,
        // but keeping it for now if needed.
        function updateRpm(componentId, value) {
            const component = simulationComponents[componentId];
            if (component) {
                component.rpm = parseInt(value);
                // Check if the element exists before trying to update its text
                const rpmValueElement = document.getElementById(`rpm-value-${componentId}`);
                if (rpmValueElement) {
                    rpmValueElement.innerText = component.rpm;
                }
                showMessageBox(`${component.label}: RPM a ${component.rpm}`);
            }
        }

        // Helper function to update the status text of all components
        function updateAllComponentStatusDisplays() {
            for (const id in simulationComponents) {
                const statusSpan = document.getElementById(`status-${id}`);
                if (statusSpan) {
                    statusSpan.innerText = simulationComponents[id].active ? 'ENCENDIDO' : 'APAGADO';
                    statusSpan.className = simulationComponents[id].active ? 'status-on' : 'status-off';
                }
            }
        }

        // Function to set up dynamic buttons for simulation components
        function setupSimulationControls() {
            const simulationPageDiv = document.getElementById('simulation-page');
            const controlGroup = simulationPageDiv.querySelector('.control-group');
            // Check if backButtonDiv exists to insert before it, otherwise append to controlGroup
            let backButtonDiv = document.getElementById('backToMainFromSimulationButton')?.closest('.button-group');

            // Create a new div to hold the component control buttons if it doesn't exist
            let componentControlsDiv = document.getElementById('component-controls');
            if (!componentControlsDiv) {
                componentControlsDiv = document.createElement('div');
                componentControlsDiv.id = 'component-controls';
                if (backButtonDiv && controlGroup.contains(backButtonDiv)) {
                    controlGroup.insertBefore(componentControlsDiv, backButtonDiv);
                } else {
                    controlGroup.appendChild(componentControlsDiv);
                }
            }
           

            const componentsToControl = [
                { id: 'component-main-silo', label: 'Almacén Principal' },
                { id: 'component-1-pulmon', label: 'Pulmón Mez. (1)' },
                { id: 'component-11', label: 'Paso Mezcladora (11)' },
                { id: 'mixer-tank', label: 'Mezcladora' },
                { id: 'component-3', label: 'Abre Mez. (3)' },
                { id: 'component-12', label: 'Noria Mez. (12)' },
                { id: 'component-2', label: 'Pulmón Mol. (2)' },
                { id: 'component-valve-right-branch', label: 'Válvula (Derecha)' },
                { id: 'component-4', label: 'Molino (4)'},
                { id: 'component-7', label: 'Elevador Mol. (7)' },
                { id: 'component-5', label: 'Balanza (5)' },
                { id: 'component-output-bottom', label: 'Salida' }
            ];

            componentControlsDiv.innerHTML = ''; // Clear previous controls if any
            componentsToControl.forEach(comp => {
                const controlDiv = document.createElement('div');
                controlDiv.classList.add('component-control');
                controlDiv.style.marginBottom = '10px';

                const currentComponentState = simulationComponents[comp.id]?.active || false;
                const statusClass = currentComponentState ? 'status-on' : 'status-off';
                const statusText = currentComponentState ? 'ENCENDIDO' : 'APAGADO';

                controlDiv.innerHTML = `
                    <h3 style="margin-bottom: 5px;">${comp.label}</h3>
                    <div class="component-button-group">
                        <button class="button-link button-green" onclick="toggleComponent('${comp.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style='vertical-align: middle; margin-right: 4px;'>
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M7 4v16l13 -8z" />
                            </svg>
                            ON/OFF
                        </button>
                    </div>
                    <div class="component-status-display">Estado: <span id="status-${comp.id}" class="${statusClass}">${statusText}</span></div>
                `;
                componentControlsDiv.appendChild(controlDiv);

                // Add RPM control for Alimentador Molino (10) - if still relevant
                if (comp.id === 'component-10') {
                    const rpmControlDiv = document.createElement('div');
                    rpmControlDiv.innerHTML = `
                        <label for="rpm-range-${comp.id}" style="margin-top: 5px;">RPM: <span id="rpm-value-${comp.id}">${simulationComponents[comp.id].rpm}</span></label>
                        <input type="range" id="rpm-range-${comp.id}" min="0" max="20" value="${simulationComponents[comp.id].rpm}" step="1" oninput="updateRpm('${comp.id}', this.value)">
                    `;
                    controlDiv.appendChild(rpmControlDiv);
                }
            });

            // Update status displays initially
            updateAllComponentStatusDisplays();
        }

        // --- Initialization Function ---
        function initApp() {
            // Load saved data
            loadFormulas();
            
            // Set up initial displays
            updateExtractorStatus();
            renderSavedFormulas();
            startWeightSimulation(); // Start weight simulation for LCD display

            // Set up simulation controls (buttons for SVG components)
            setupSimulationControls();

            // Event Listeners for Page Navigation Buttons
            document.getElementById('showFormulasButton').addEventListener('click', () => {
                showPage('formulas-page');
                renderFormulasPage(); // Re-render formula inputs when showing page
                renderSavedFormulas(); // Re-render saved formulas list
            });

            document.getElementById('backToMainFromFormulasButton').addEventListener('click', () => {
                showPage('main-control-page');
            });

            document.getElementById('showSimulationButton').addEventListener('click', () => {
                showPage('simulation-page');
                renderSimulationState(); // Ensure simulation state is rendered when showing page
            });

            document.getElementById('backToMainFromSimulationButton').addEventListener('click', () => {
                showPage('main-control-page');
            });

            document.getElementById('save-config-button').addEventListener('click', saveExtractorConfig);
            document.getElementById('backToMainFromConfigButton').addEventListener('click', () => {
                showPage('main-control-page');
            });

            document.getElementById('tareButton').addEventListener('click', tareWeight);
            document.getElementById('startRoutineButton').addEventListener('click', startRoutine);
            document.getElementById('cancelRoutineButton').addEventListener('click', hideStartRoutineModal);
            document.getElementById('saveFormulaButton').addEventListener('click', saveFormula);
        }

        // Ensure initApp is called when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
